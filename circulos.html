<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>TIRO AL BLANCO</title>
    <style type="text/css">
      canvas {
        border : solid 2px;
      }
    </style>
  </head>
  <body>
        <canvas id="myCanvas" width="1200" height="720" >

        </canvas>  
    <div class="row">
      <div class="container">
        <div class="col-md-4">
          <button type="button" class="btn btn-lg btn-primary" id="btn_lanzar" disabled>Lanzar dardo</button>
        </div>
        <div class="col-md-8" id="probabilidades">

        </div>
      </div>
    </div>
    <!-- Modal -->
    <div class="modal fade bd-example-modal-sm" id="mdl_inicio" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Datos iniciales</h5>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label>Cantidad de circulos a dibujar:</label>
                <input type="text" class="form-control" id="inpt_num_circulos">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" id="btn_iniciar" class="btn btn-lg btn-primary">Aceptar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="mdl_puntajes" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Datos iniciales</h5>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label><b>Del</b> circulo <b>más pequeño al</b> circulo <b>más grande</b>, digite separando por comas, los puntajes correspondientes:</label>
                <input type="text" class="form-control" id="inpt_puntajes_circulos">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" id="btn_puntajes" class="btn btn-lg btn-primary">Aceptar</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script>
      var cantidad_circulos = 0;
      var contador_circulos = 0;
      var circulos = [];
      var puntajes = [];
      var dibujar = true;

      var circle;
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      
      $(document).ready(function(){
        $('#mdl_inicio').modal('show');
        initCanvas();
      });

      canvas.addEventListener('click', function(evt) {
        if(dibujar){
          var mousePos = getMousePos(canvas, evt);

          mousePos.x -= 1;
          mousePos.x -= 1;

          drawCircle(mousePos);
        }
      }, false);

      $("#btn_iniciar").on('click', function(){
        var temp_cantidad_circulos = $("#inpt_num_circulos").val();
        if(temp_cantidad_circulos != null && temp_cantidad_circulos != ''){
          if(!isNaN(temp_cantidad_circulos)){
            if(temp_cantidad_circulos > 1){
              cantidad_circulos = temp_cantidad_circulos;
              $('#mdl_inicio').modal('hide');
            }else{
              alert("Digite un numero mayor a 1");
            }
          }else{
            alert("Digite un numero");
          }
        }else{
            alert("Digite un valor");
        }
      });

      $("#btn_puntajes").on('click', function(){
        var temp_puntajes = $("#inpt_puntajes_circulos").val().trim();
        var temp_arr_puntajes = temp_puntajes.split(",");
        if(temp_arr_puntajes.length == cantidad_circulos){
          $('#mdl_puntajes').modal('hide');
          for (let i = circulos.length - 1; i >= 0; i--){
            context.font = "10px Comic Sans MS";
            if(((i+1)%2)==0){
              context.fillStyle = 'white';
            }else{
              context.fillStyle = 'black';
            }
            context.textAlign = "center";
            context.fillText(temp_arr_puntajes[i], 1200/2, (720/2)-circulos[i]+20);
          }
          puntajes = temp_arr_puntajes;
          calcularProbabilidad();
          $("#btn_lanzar").removeAttr("disabled");
        }else{
          alert('La cantidad de puntajes no concuerda con la cantidad de circulos creados');
        }
      });

      $("#btn_lanzar").on('click', function(){
        lanzarDardo();
      });

      function lanzarDardo(){
        var x_min = (1200/2 - circulos[circulos.length-1]);
        var x_max = (1200/2 + circulos[circulos.length-1]);
        
        var y_min = (720/2 - circulos[circulos.length-1]);
        var y_max = (720/2 + circulos[circulos.length-1]);

        do{
          var y = Math.random() * (y_max - y_min) + y_min;
          var x = Math.random() * (x_max - x_min) + x_min;
          var distancia = distanciaPuntos(x, y);
        }while(circulos[circulos.length - 1] < distancia);
        
        context.font = "20px Comic Sans MS";
        context.fillStyle = 'blue';
        context.textAlign = "center";
        context.fillText("X", x, y);
      }

      function distanciaPuntos(x, y){
        return Math.sqrt(Math.pow(x - 1200/2, 2) + Math.pow(y - 720/2, 2));
      }

      function calcularProbabilidad(){
        var print = "";
        var area_total = Math.PI*Math.pow(circulos[circulos.length-1],2);
        for (let i = 0; i < circulos.length; i++) {
          let area_anterior = (circulos[i-1] != undefined ? Math.PI*Math.pow(circulos[i-1],2) : 0);
          let area_actual = Math.PI*Math.pow(circulos[i],2);
          let area_favorable = area_actual - area_anterior;
          let probabilidad = area_favorable/area_total;
          let porcentaje = probabilidad * 100;
          print += "<b>"+porcentaje+"%</b> de obtener " + puntajes[i] + " puntos. <br>";
        }
        printProbabilidad(print);
      }

      function printProbabilidad(probabilidad){
        $("#probabilidades").append(probabilidad);
      }
      
      function drawCircle(mousePos){
        var x = 1200; 
        var y = 720; 
        var px = x/2;
        var py = y/2;
        var radio = Math.sqrt( Math.pow((mousePos.x-px),2) + Math.pow((mousePos.y-py),2));
        if(radio <= 359){
          contador_circulos++;
          
          circulos.push(radio);
          circulos.sort(function(a, b){return a-b});

          circle.beginPath();
          circle.arc(px,py,radio,0,radianes(360),true);
          circle.stroke();

          if(contador_circulos >= cantidad_circulos){
            dibujar = false;
            $("#mdl_puntajes").modal('show');

            for (let i = circulos.length - 1; i >= 0; i--) {
              let tem_circle = circulos[i];
              
              circle.beginPath();
              circle.arc(px,py, tem_circle , 0,radianes(360),true);
              if(i == 0){ circle.fillStyle = 'red'; }else{
                if((i%2)==0){
                  circle.fillStyle = 'white';
                }else{
                  circle.fillStyle = 'black';
                }
              }
              circle.fill();
              circle.lineWidth = 1;
              if(i == 0){ circle.strokeStyle = '#FF0202'; }else{
                if((i%2)==0){
                  circle.strokeStyle = '#FFF';
                }else{
                  circle.strokeStyle = '#000';
                }
              }
              circle.stroke();
            }
          }
        }
      }

      function radianes(grados){
        var radianes = (Math.PI/180)*grados;
        return radianes;
      }

      function getMousePos(canvas, evt) {
        return {
          x: evt.clientX,
          y: evt.clientY
        };
      }

      function initCanvas(){
        circle = canvas.getContext('2d');
        context.lineWidth = 2;
        context.stroke();
      }
    </script>
  </body>
</html>